<!doctype html>
<html>
<head>
  <title>Network | Basic usage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/javascript" src="http://localhost:8080/static/js/lib/jquery-3.1.1.min.js"></script>
  <script type="text/javascript" src="http://localhost:8080/static/js/lib/dist/vis.js"></script>
  <script src="http://localhost:8080/static/js/lib/d3.v4.min.js"></script>
  <link rel="stylesheet" href="http://localhost:8080/static/css/pure-min.css">
  <script type="text/javascript" src="http://localhost:8080/static/js/lib/lodash.js"></script>
  <script src="http://localhost:8080/static/js/src/sigma.core.js"></script>
  <script src="http://localhost:8080/static/js/src/conrad.js"></script>
  <script src="http://localhost:8080/static/js/src/utils/sigma.utils.js"></script>
  <script src="http://localhost:8080/static/js/src/utils/sigma.polyfills.js"></script>
  <script src="http://localhost:8080/static/js/src/sigma.settings.js"></script>
  <script src="http://localhost:8080/static/js/src/classes/sigma.classes.dispatcher.js"></script>
  <script src="http://localhost:8080/static/js/src/classes/sigma.classes.configurable.js"></script>
  <script src="http://localhost:8080/static/js/src/classes/sigma.classes.graph.js"></script>
  <script src="http://localhost:8080/static/js/src/classes/sigma.classes.camera.js"></script>
  <script src="http://localhost:8080/static/js/src/classes/sigma.classes.quad.js"></script>
  <script src="http://localhost:8080/static/js/src/classes/sigma.classes.edgequad.js"></script>
  <script src="http://localhost:8080/static/js/src/captors/sigma.captors.mouse.js"></script>
  <script src="http://localhost:8080/static/js/src/captors/sigma.captors.touch.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/sigma.renderers.canvas.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/sigma.renderers.webgl.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/sigma.renderers.svg.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/sigma.renderers.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/webgl/sigma.webgl.nodes.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/webgl/sigma.webgl.nodes.fast.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/webgl/sigma.webgl.edges.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/webgl/sigma.webgl.edges.fast.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/webgl/sigma.webgl.edges.arrow.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.labels.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.hovers.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.nodes.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.edges.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.edges.curve.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.edges.arrow.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.edges.curvedArrow.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.edgehovers.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.edgehovers.curve.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.edgehovers.arrow.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.edgehovers.curvedArrow.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/canvas/sigma.canvas.extremities.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/svg/sigma.svg.utils.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/svg/sigma.svg.nodes.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/svg/sigma.svg.edges.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/svg/sigma.svg.edges.curve.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/svg/sigma.svg.labels.def.js"></script>
  <script src="http://localhost:8080/static/js/src/renderers/svg/sigma.svg.hovers.def.js"></script>
  <script src="http://localhost:8080/static/js/src/middlewares/sigma.middlewares.rescale.js"></script>
  <script src="http://localhost:8080/static/js/src/middlewares/sigma.middlewares.copy.js"></script>
  <script src="http://localhost:8080/static/js/src/misc/sigma.misc.animation.js"></script>
  <script src="http://localhost:8080/static/js/src/misc/sigma.misc.bindEvents.js"></script>
  <script src="http://localhost:8080/static/js/src/misc/sigma.misc.bindDOMEvents.js"></script>
  <script src="http://localhost:8080/static/js/src/misc/sigma.misc.drawHovers.js"></script>
</head>
<style>
  .pure-table{
    margin-bottom: 10px
  }
  .btns{
    padding: 10px 0;
  }
  .links line {
    stroke: #999;
    stroke-opacity: 0.6;
  }

  .nodes circle {
    stroke: #fff;
    stroke-width: 1.5px;
  }
  .my-graph{
    width:100%;
    min-height:800px;
  }
</style>
<body>
<div class="pure-g">
    <div class="pure-u-2-3 canvas">
      <div id="mynetwork" width="800" height="800" style="display:none;width:800px;height:800px;">
        
      </div>
      <svg width="800" height="800" class="my-graph" style="display:none">
      
      </svg>
      <div id="container" style="display:none">
        <style>
          #graph-container {
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            position: absolute;
          }
        </style>
        <div id="graph-container"><canvas class="sigma-scene" width="2560px" height="490px" style="position: absolute; width: 1280px; height: 245px;"></canvas><canvas class="sigma-labels" width="2560px" height="490px" style="position: absolute; width: 1280px; height: 245px;"></canvas><canvas class="sigma-mouse" width="2560px" height="490px" style="position: absolute; width: 1280px; height: 245px;"></canvas></div>
      </div>
    </div>
    <div class="pure-u-1-3">
      <table class="pure-table">
          <thead>
              <tr>
                  <th>Nodes</th>
                  <th>Edges</th>
              </tr>
          </thead>
          <tbody>
              <tr>
                  <td id="nodes"> ... </td>
                  <td id="edges"> ... </td>
              </tr>
          </tbody>
      </table>
      <div class="btns data">
        <button class="pure-button" type="button" value="social_network_100_1578.json">100</button>
        <button class="pure-button" type="button" value="social_network_250_3827.json">250</button>
        <button class="pure-button" type="button" value="social_network_500_7882.json">500</button>
      </div>
      <div class="btns tools">
        <button class="pure-button" type="button" value="svg">SVG</button>
        <button class="pure-button" type="button" value="canvas">Canvas</button>
        <button class="pure-button" type="button" value="webgl">Webgl</button>
      </div>
    </div>
</div>
<script src="http://localhost:8080/static/js/plugins/sigma.layout.forceAtlas2/worker.js"></script>
<script src="http://localhost:8080/static/js/plugins/sigma.layout.forceAtlas2/supervisor.js"></script>
<script>
  var globalData = {
    data: [],
    name: '',
    renderTool: '',
    nodesCount: 0,
    edgesCount: 0,
    fps:0,
    time:0,
    transwebgl: function(data){
      var nodes = []
      var edges = []
      for(var i=0; i<data.length; i++){
        if(nodes.indexOf(data[i].from) < 0){
          nodes.push(data[i].from)
        }
        if(nodes.indexOf(data[i].to) < 0){
          nodes.push(data[i].to)
        }
        edges.push({
          id: 'e'+ i,
          source: data[i].from,
          target: data[i].to
        })
      }
      oNodes = _.map(nodes,function(o){
        return {
          id: o,
          x: 100 * Math.cos(2 * i * Math.PI / nodes.length),
          y: 100 * Math.sin(2 * i * Math.PI / nodes.length),
          size: Math.random()
        }
      })

      

      return { nodes: oNodes, edges: edges}
    },
    transsvg: function(data){
      var nodes = []
      var edges = []
      for(var i=0; i<data.length; i++){
        if(nodes.indexOf(data[i].from) < 0){
          nodes.push({
            id: data[i].from
          })
        }
        if(nodes.indexOf(data[i].to) < 0){
          nodes.push({
            id: data[i].to
          })
        }
        edges.push({
          source: data[i].from,
          target: data[i].to
        })
      }

      var nodesDistict = _.uniq(nodes, function(o){
          return o.id;
      });
      
      return { nodes: nodesDistict, links: edges}

    },
    transcanvas: function(data){
      var nodes = []
      var edges = []
      for(var i=0; i<data.length; i++){
        if(nodes.indexOf(data[i].from) < 0){
          nodes.push(data[i].from)
        }
        if(nodes.indexOf(data[i].to) < 0){
          nodes.push(data[i].to)
        }
        edges.push({
          from: data[i].from,
          to: data[i].to
        })
      }
      oNodes = _.map(nodes,function(o){
        return {
          id: o
        }
      })

      

      return { nodes: oNodes, edges: edges}

    },
    svg: function(graph){

      // svg function
         var svg = d3.select(".my-graph"),
          width = +svg.attr("width"),
          height = +svg.attr("height")

          var color = d3.scaleOrdinal(d3.schemeCategory20);
          var simulation = d3.forceSimulation()
              .force("link", d3.forceLink().id(function(d) { return d.id; }))
              .force("charge", d3.forceManyBody())
              .force("center", d3.forceCenter(width / 2, 0));

          var link = svg.append("g")
          .attr("class", "links")
          .selectAll("line")
          .data(graph.links)
          .enter().append("line")
            .attr("stroke-width", function(d) { return Math.sqrt(d.value); });

            var node = svg.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(graph.nodes)
                .enter().append("circle")
                  .attr("r", 5)
                  .attr("fill", function(d) { return color(d.group); })
                  .call(d3.drag()
                      .on("start", dragstarted)
                      .on("drag", dragged)
                      .on("end", dragended));

                node.append("title")
                    .text(function(d) { return d.id; });

                simulation
                    .nodes(graph.nodes)
                    .on("tick", ticked);

                simulation.force("link")
                    .links(graph.links);

                function ticked() {
                  link
                      .attr("x1", function(d) { return d.source.x; })
                      .attr("y1", function(d) { return d.source.y; })
                      .attr("x2", function(d) { return d.target.x; })
                      .attr("y2", function(d) { return d.target.y; });

                  node
                      .attr("cx", function(d) { return d.x; })
                      .attr("cy", function(d) { return d.y; });
                }    

                function dragstarted(d) {
                  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                  d.fx = d.x;
                  d.fy = d.y;
                }

                function dragged(d) {
                  d.fx = d3.event.x;
                  d.fy = d3.event.y;
                }

                function dragended(d) {
                  if (!d3.event.active) simulation.alphaTarget(0);
                  d.fx = null;
                  d.fy = null;
                }

    },
    canvas: function(graph){

            console.log(graph)
            // create an array with Nodes
            var nodes = new vis.DataSet(graph.nodes);

            // create an array with edges
            var edges = new vis.DataSet(graph.edges);

            // create a network
            var container = document.getElementById('mynetwork');
            var data = {
              nodes: nodes,
              edges: edges
            };
            var options = {
                  interaction: {
                  dragNodes: true,
                  dragView: true,
                  hideEdgesOnDrag: false,
                  hideNodesOnDrag: false,
                  hover: true,
                  hoverConnectedEdges: false,
                  keyboard: {
                      enabled: false,
                      speed: {x: 10, y: 10, zoom: 0.02},
                      bindToWindow: true
                  },
                  navigationButtons: true,
                  selectable: true,
                  selectConnectedEdges: false,
                  tooltipDelay: 100,
                  zoomView: true,
                  tooltipDelay: 200,
                  hideEdgesOnDrag: true
              },
              layout: {
                  hierarchical: {
                      enabled: false,
                      levelSeparation: 150,
                      direction: 'UD',   // UD, DU, LR, RL
                      sortMethod: 'hubsize' // hubsize, directed
                  },
                  improvedLayout:false
              },

              nodes: {
                  labelHighlightBold: false,
                  font: {
                      color: '#555',
                  },
                  color: {
                      border: 'null',
                      background: '#97C2FC',
                      highlight: {
                          border: '#2B7CE9',
                          background: '#D2E5FF'
                      },
                      hover: {
                          border: '#2B7CE9',
                          background: '#D2E5FF'
                      }
                  }
              },
              edges: {
                  labelHighlightBold: false,
                  arrows: {
                      to:{
                          enabled: true,
                          scaleFactor: 1
                      }
                  },
                  font: {
                      face: 'FontAwesome',
                      size: 15,
                      color: '#666'
                  },
                  //dashes: true,
                  width: 1,
                  hoverWidth: 0,
                  selectionWidth: 0,
                  color: '#999',
                  //color: {
                  //    color: '#999',
                  //    hover: '#000',
                  //    // selected color
                  //    //highlight: '#c1c1c1'
                  //},
                  smooth: {
                      enabled: false
                  }
              },

              physics: {
                  stabilization: {
                      enabled: false,
                      iterations: 1000,
                      updateInterval: 100,
                      onlyDynamicEdges: false,
                      fit: true
                  },
                  solver: 'forceAtlas2Based',
                  forceAtlas2Based: {
                      gravitationalConstant: -50,
                      centralGravity: 0.01,
                      springConstant: 0.08,
                      springLength: 200,
                      damping: 0.4,
                      avoidOverlap: 100
                  },

              },
            };
            var network = new vis.Network(container, data, options);



    },
    webgl: function(graph){


        s = new sigma({
          graph: graph,
          container: 'graph-container',
          settings: {
            drawEdges: true
          }
        });

        // Start the ForceAtlas2 algorithm:
        s.startForceAtlas2({worker: true, barnesHutOptimize: false});




    }
  } 
  $('.data button').click(function(e){
    var _this = this
    $('.data button').removeClass('pure-button-primary')
    $(this).addClass('pure-button-primary')
    $.ajax({
      method: 'GET',
      url: '/graph',
      data: {
        file: _this.value
      }
    }).done(function(res){
      globalData.data = res
      globalData.nodesCount = _this.textContent
      globalData.edgesCount = res.length
      mountData()
    })
  })

  $('.tools button').click(function(e){
    switch(this.value){
      case 'svg':
        $('.my-graph').css('display', 'block')
        var cooked = globalData.transsvg(globalData.data)
        globalData.svg(cooked)
        break;
      case 'canvas':
        $('#mynetwork').css('display', 'block')
        var cooked = globalData.transcanvas(globalData.data)
        globalData.canvas(cooked)
        break;
      case 'webgl':
        $('#container').css('display', 'block')
        var cooked = globalData.transwebgl(globalData.data)
        globalData.webgl(cooked)
        break;
    }
  })

  function mountData(){
    $('#nodes').html(globalData.nodesCount)
    $('#edges').html(globalData.edgesCount)
    $('#fps').html(globalData.fps)
    $('#time').html(globalData.time)
  }
</script>
<script>
  javascript:(function(){var script=document.createElement('script');script.onload=function(){var stats=new Stats();document.body.appendChild(stats.dom);requestAnimationFrame(function loop(){stats.update();requestAnimationFrame(loop)});};script.src='//rawgit.com/mrdoob/stats.js/master/build/stats.min.js';document.head.appendChild(script);})()
</script>
</body>
</html>
